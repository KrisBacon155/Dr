-- ReplicatedStorage.DroneModules.DroneScanner
return function(player, character, drone, Effects)
	local Players = game:GetService("Players")
	local RunService = game:GetService("RunService")
	local camera = workspace.CurrentCamera

	local hrp = character:WaitForChild("HumanoidRootPart")

	local gui = Instance.new("ScreenGui", player:WaitForChild("PlayerGui"))
	gui.Name = "DroneGui"
	gui.ResetOnSpawn = false

	local scanMode = "Players"
	local spinning = false

	local scanBtn = Instance.new("TextButton")
	scanBtn.Size = UDim2.new(0, 100, 0, 40)
	scanBtn.Position = UDim2.new(0, 30, 0, 200)
	scanBtn.BackgroundColor3 = Color3.new(0.1, 0.1, 0.1)
	scanBtn.TextColor3 = Color3.new(1, 1, 1)
	scanBtn.Text = "Scan"
	scanBtn.Font = Enum.Font.GothamBold
	scanBtn.Parent = gui
	scanBtn.Active = true
	scanBtn.Draggable = true
	scanBtn.ZIndex = 2

	local toggleBtn = Instance.new("TextButton")
	toggleBtn.Size = UDim2.new(0, 100, 0, 40)
	toggleBtn.Position = UDim2.new(0, 30, 0, 250)
	toggleBtn.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
	toggleBtn.TextColor3 = Color3.new(1, 1, 1)
	toggleBtn.Text = "Mode: Players"
	toggleBtn.Font = Enum.Font.GothamBold
	toggleBtn.Parent = gui
	toggleBtn.Draggable = true
	toggleBtn.ZIndex = 2

	toggleBtn.MouseButton1Click:Connect(function()
		scanMode = (scanMode == "Players") and "NPCs" or (scanMode == "NPCs" and "Items") or "Players"
		toggleBtn.Text = "Mode: " .. scanMode
	end)

	local function scanPulse()
		if not spinning then
			spinning = true
			task.spawn(function()
				Effects.spinDrone(drone)
				spinning = false
			end)
		end

		for _, model in pairs(workspace:GetDescendants()) do
			if model:IsA("Model") and model:FindFirstChild("HumanoidRootPart") and model ~= character then
				local isPlayer = Players:GetPlayerFromCharacter(model) ~= nil
				local isItem = model:FindFirstChild("IsItem")
				if (scanMode == "Players" and isPlayer) or (scanMode == "NPCs" and not isPlayer) or (scanMode == "Items" and isItem) then
					local dist = (hrp.Position - model.HumanoidRootPart.Position).Magnitude
					if dist <= 1500 then
						Effects.createPulseCircle(model, hrp.Position)
						Effects.createExclamationAbove(model, hrp.Position)
					end
				end
			end
		end
	end

	scanBtn.MouseButton1Click:Connect(scanPulse)

	RunService.RenderStepped:Connect(function(dt)
		local lookVector = hrp.CFrame.LookVector
		local upDown = math.sin(tick() * 2) * 0.5
		local followPos = hrp.Position + Vector3.new(0, 4 + upDown, 0) - lookVector * 4
		drone.CFrame = CFrame.new(followPos, followPos + lookVector)
	end)

	player.CharacterAdded:Connect(function(char)
		character = char
		hrp = char:WaitForChild("HumanoidRootPart")
	end)
end
