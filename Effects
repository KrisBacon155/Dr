-- ReplicatedStorage.DroneModules.DroneEffects
local TweenService = game:GetService("TweenService")
local Players = game:GetService("Players")
local camera = workspace.CurrentCamera

local function getDistanceColor(distance)
	if distance <= 100 then
		return Color3.fromRGB(255, 0, 0)
	elseif distance <= 300 then
		return Color3.fromRGB(255, 255, 255)
	else
		return Color3.fromRGB(0, 255, 0)
	end
end

local function createPulseCircle(model, referencePosition)
	local hrp = model:FindFirstChild("HumanoidRootPart")
	if not hrp then return end

	local attachment = Instance.new("Attachment", hrp)

	local ring = Instance.new("ParticleEmitter")
	ring.Texture = "rbxassetid://92229924136385"
	ring.LightInfluence = 0
	ring.ZOffset = 1
	ring.Size = NumberSequence.new({
		NumberSequenceKeypoint.new(0, 1),
		NumberSequenceKeypoint.new(1, 8)
	})
	ring.Transparency = NumberSequence.new({
		NumberSequenceKeypoint.new(0, 0.2),
		NumberSequenceKeypoint.new(1, 1)
	})
	ring.Lifetime = NumberRange.new(1.25)
	ring.Rate = 1
	ring.Speed = NumberRange.new(0)
	ring.Rotation = NumberRange.new(0)
	ring.RotSpeed = NumberRange.new(0)
	ring.Color = ColorSequence.new(getDistanceColor((hrp.Position - referencePosition).Magnitude))
	ring.Enabled = true
	ring.Parent = attachment

	task.delay(1.25, function()
		attachment:Destroy()
	end)
end

local function createExclamationAbove(model, referencePosition)
	local head = model:FindFirstChild("Head")
	if not head then return end

	local distance = (camera.CFrame.Position - head.Position).Magnitude
	local scale = math.clamp(100 / distance, 0.7, 2.5)
	local color = getDistanceColor(distance)

	local gui = Instance.new("BillboardGui", model)
	gui.Size = UDim2.new(0, 40 * scale, 0, 40 * scale)
	gui.StudsOffset = Vector3.new(0, 3, 0)
	gui.AlwaysOnTop = true
	gui.Adornee = head

	local label = Instance.new("TextLabel", gui)
	label.Size = UDim2.new(1, 0, 1, 0)
	label.BackgroundTransparency = 1
	label.Text = "!"
	label.TextColor3 = color
	label.TextScaled = true
	label.Font = Enum.Font.Arcade
	label.TextStrokeTransparency = 0.5

	local tween = TweenService:Create(label, TweenInfo.new(1.5), {
		TextTransparency = 1,
		TextStrokeTransparency = 1
	})
	tween:Play()
	tween.Completed:Connect(function()
		gui:Destroy()
	end)
end

local function spinDrone(drone)
	for _ = 1, 3 do
		local spin = TweenService:Create(drone, TweenInfo.new(0.15, Enum.EasingStyle.Linear), {
			CFrame = drone.CFrame * CFrame.Angles(0, math.rad(120), 0)
		})
		spin:Play()
		spin.Completed:Wait()
	end
end

return {
	createPulseCircle = createPulseCircle,
	createExclamationAbove = createExclamationAbove,
	spinDrone = spinDrone
}
